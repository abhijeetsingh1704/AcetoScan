#!/bin/bash

# File: AcetoScan
# Last modified: Tor Sep 19, 2019 19:50
# Sign: Abhi

set -euo pipefail

echo \
" ___________________________________________________________
|     _    ____ _____ _____ ___  ____   ____    _    _   _  |
|    / \  / ___| ____|_   _/ _ \/ ___| / ___|  / \  | \ | | |
|   / _ \| |   |  _|   | || | | \___ \| |     / _ \ |  \| | |
|  / ___ \ |___| |___  | || |_| |___) | |___ / ___ \| |\  | |
| /_/   \_\____|_____| |_| \___/|____/ \____/_/   \_\_| \_| |
|___________________________________________________________|
"

###    Recording the time whent he script was started

start=$(date +%s) #start time of script

###     Setting up variables

input_dir=""            
output_dir=""           
read_type=""
max_len=""
min_len=""
qual=""            
cluster_threshold=""
cluster_size=""

###     Username

user=`echo ${SUDO_USER:-${USER}}`

###     Defaults

output_dir_def="/home/$user/acetoscan/output_data"
read_type_def="1"
max_len_def="277"
min_len_def="150"
qual_def="20" 
cluster_threshold_def="0.95"
cluster_size_def="5"
version_def="0.1.0"

###    Getting processors information

THREADS=$(nproc 2> /dev/null || sysctl -n hw.ncpu 2> /dev/null || getconf _NPROCESSORS_ONLN 2> /dev/null)

###     Defining flags

#       function

usage() {
echo "Usage   : $0 [-i <input directory>] [-o <output directory>] [-m <max_length>] [-n <min_length>] [-q <quality threshold>] [-r <reads type>] [-t <clustering threshold>] [-c <min_cluster size>]
Example : acetoscan -i /<input path>/ -o /<output path>/ -m 277 -n 150 -q 20 -r 1 -t 0.95 -c 5" 1>&2; exit 1;
}


#       flags

while getopts "i:o:m:n:q:r:t:c:hv" flags; 
        do      
                case "${flags}" in
                        
                        i)
                                input_dir=${OPTARG}
                                ;;

                        o)
                                output_dir=${OPTARG}
                                ;;

                        m)
                                max_len=${OPTARG}
                                ;;

                        n)
                                min_len=${OPTARG}
                                ;;

                        q)
                                qual=${OPTARG}
                                ;;
                        
                        r)
                                read_type=${OPTARG}
                                ;;

                        t)
                                cluster_threshold=${OPTARG}
                                ;;
                                
                        c)
                                cluster_size=${OPTARG}
                                ;;

                        h)
                                echo "
Example : acetoscan -i /<input path>/ -o /<output path>/ -m 277 -n 150 -q 20 -r 1 -t 0.95 -c 5

        -i      Input directory containing raw illumina data
        -o      Output directory
                        :default = /home/${user}/acetoscan/output_data
        -m      Maximum length of sequence after quality filtering
                        :defalut max_length = 277
        -n      Minimum length of sequence after quality filtering
                        :defalut min_length = 150
        -q      Quality threshold for the sequences 
                        :default quality threshold = 20
        -r      Read type either forward or reverse reads 
                        1 = forward reads (default)
                        2 = reverse reads
        -t      Clustering threshold
                        :default cluster threshold = 0.95 (95 %)
        -c      Minimum cluster size
                        :default minimum cluster size = 5
        -h      print Help
        -v      print acetoscan version"
                                exit                                
                                ;;

                        v)
                                echo "AcetoScan version: ${version_def}"
                                echo "Visit \"https://acetobase.molbio.slu.se/\" for more information."
                                exit
                                ;;

                        *)
                                usage
                                exit
                                ;;

                        :)      
                                usage
                                exit
                                ;;
                        
                        \?)
                                usage
                                exit
                                ;;

                esac
        done

shift $((OPTIND-1))

###     check

if ((OPTIND == 1));then
echo -e "\n#Input directory not provided, Aborting!"
        echo ""
        usage
        exit
fi


###     Checking input_dir 

if [ ! -d "$input_dir" ] && [ -x "$input_dir" ]; then
        echo -e "\n#Input directory not provided, Aborting!"
        echo ""
        usage
        exit
else
        echo -e "\n#Content of input directory: $input_dir"        
        forward_read_count=$(find "$input_dir" -name '*_R1_001.fastq.gz' | wc -l)
        reverse_read_count=$(find "$input_dir" -name '*_R2_001.fastq.gz' | wc -l)
        echo "-> Number of forward read files: $forward_read_count"
        echo "-> Number of reverse read files: $reverse_read_count"
        
        
fi

###     Checking output_dir 


if [ "$output_dir" == "" ]; then
        output_dir="$output_dir_def"
        echo -e "\n#Using default output directory: $output_dir_def"
        if [ -d "$output_dir_def" ] ; then
                echo -ne ""
        else
                mkdir -p "$output_dir_def"
        fi
else
        if [  -d "$output_dir" ] && [ -x "$output_dir" ]; then
                echo -e "\n#Output directory: $output_dir "
        else
                if [ ! -d "$output_dir" ]; then   
                        mkdir -p "$output_dir"
                        echo -e "\n#Output directory: $output_dir "
                else
                       echo -e "\n#Cannot access/create $output_dir " 
                fi
        fi
fi

###     setting up working directory

export WKDIR="$output_dir"

###     Checking maximum length threshold

if [ "$max_len" == "" ];then
        max_len="$max_len_def"
        echo -e "\n#Using default max_length: 277"
else
       echo -e "\n#Using max_length: ${max_len}"
fi

###     Checking minimum length threshold

if [ "$min_len" == "" ];then
        min_len="$min_len_def"
        echo -e "\n#Using default min_length: 150"
else
       echo -e "\n#Using min_length: ${min_len}"
fi

###     Checking quality threshold

if [ "$qual" == "" ];then
        qual="$qual_def"
        echo -e "\n#Using default quality threshold: 20"
else
       echo -e "\n#Using quality threshold: ${qual}"
fi

###     Checking read type

if [ "$read_type" == "" ];then
        read_type="$read_type_def"
        echo -e "\n#Using default: Forward reads"
else
       echo -e "\n#Using R${read_type} reads"
fi

#       read variable

export reads="R${read_type}"
export MaxL="$max_len"
export MinL="$min_len"
export QT="$qual"

###     Checking clustering threshold

if [ "$cluster_threshold" == "" ];then
        cluster_threshold="$cluster_threshold_def"
        echo -e "\n#Using default clustering threshold: 0.95"
else
        echo -e "\n#Clustering threshold: $cluster_threshold"
fi

###     Checking minimum clustering size

if [ "$cluster_size" == "" ];then
        cluster_size="$cluster_size_def"
        echo -e "\n#Using default minimum cluster size : 5"
else
        echo -e "\n#Minimum cluster size: $cluster_size"
fi

###    Checking threshold validity

MAXTHRESHOLD=1.0

if (( ${cluster_threshold%%.*} < ${MAXTHRESHOLD%%.*} || ( ${cluster_threshold%%.*} == ${MAXTHRESHOLD%%.*} \
    && ${cluster_threshold##*.} < ${MAXTHRESHOLD##*.} ) )) > /dev/null ; then    
    echo "" > /dev/null
else
    echo -e "\n#Invalid threshold: value must be between 0.0 and 1.0" && exit 1
fi

###     Checking of output_data directory is has content

###    Checking and cleaning the input_data and output_data directory

if [ ! -z "$(ls -A "$output_dir")" ]; then
   echo -e "\n#WARNING: directory \"$output_dir\" is not empty, possibility of data loss!!!"
   
        #       Compressing previous data
        echo -e "\n#Compressing previous data to /home/$user/${user}_${start}_backup.tar.gz"
        tar -zcf /home/$user/acetoscan_backup_${start}.tar.gz ${WKDIR}
       
        #       Cleaning
        echo -e "\n#Removing previous data from ${WKDIR}"
        rm -f ${WKDIR}/input_data/*
        rm -rf ${WKDIR}/output_data/*
        rm -f ${WKDIR}/acetoscan_result/*
else
        #       creating new directories
        echo -e "\n#Creating directories"
        mkdir -v -p "${WKDIR}/input_data"
        mkdir -v -p "${WKDIR}/output_data"
        mkdir -v -p "${WKDIR}/acetoscan_result"
fi

###    Checking dependencies

echo -e "\n#Performing dependencies check"
export PATH="/home/$user/acetoscan/acetoscan_bin/:${PATH}"
AcetoScan_software_check.sh # <======== External script

###    find illumina raw reads and making soft links to the data

if ! cd "${WKDIR}/input_data/" ; then
    echo -e "\n#Error: could not cd to ${WKDIR}/input_data/"
    exit 1
fi

#       softlinks

find "${input_dir}" -name "*_${reads}_001.fastq.gz" -exec ln -s {} "${WKDIR}/input_data/" \; 2> /dev/null

###    Checking if link exist

if [ ! -n "$(find "${WKDIR}/input_data/" -maxdepth 1 -type l -name "*_${reads}_001.fastq.gz" -print -quit)" ] ; then
    echo -e "\n#Input files \"*_${reads}*.fastq.gz\" not found in ${WKDIR}/input_data/, Aborting !!!"
    exit 1
fi



###     function for the processing bar


spin=( '/' '-' '\' '|' )

processing() {
              while [ 1 ]
                do
                   for s in "${spin[@]}"
                        do
                                echo -ne "\r[Processing:]$s"
                                sleep 0.25
                        done
                done &
}

###    Adapter trimming and quality filtering of the raw reads

mkdir -p "${WKDIR}/output_data/trimmed"
echo -e "\n#Performing adapters trimming and quality filtering"
echo -e "\n#OBS: This might take a while!"

###     CUTADAPT <--- from external script

        #       making progress bar for cudadapt script
                
        processing
        pid=$!
        
        #cutadapt external script        
        AcetoScan_cutadapt.sh   # <============= external script
                
        echo -ne "Done\n"
        kill $pid 

###     Begin Longest best frame analysis <--- from external script

echo -e "\n#Performing longest best frame analysis"
echo -e "\n#OBS: This might take a while!"

        #       making progress bar for best frame script

        processing
        pid=$!
        
        #longorf-acetoscan external script
        
        find ${WKDIR}/output_data/trimmed/ -name "*_trimmed_${reads}.fasta" \
        -execdir sh -c 'f="{}"; b=$(basename "${f}" .fasta); AcetoScan_longorf.pl --filter "$f" > "Best_${b}.fasta"' \; # <============= external script
        
        echo -ne "Done\n"        
        kill $pid 

###     Preprocessing for Clustering

cd "${WKDIR}/output_data/trimmed"
echo -e "\n#Preprocessing for clustering"
echo ""

processing
pid=$!

#       Finding and replacing the fasta header with file name

find ${WKDIR}/output_data/ -type f -iname "Best*.fasta" -printf "%f\n" | while read x;
        do 
             awk '/^>/ {gsub(/.fa(sta)?$/,"",FILENAME);printf(">%s\n",FILENAME);next;} {print}' "${x}"
        done > All_best.fasta.tmp

###     Formating input for vsearch

perl -npe 'if(!/^>/){s/\S{60}/$&\n/g};{s/-/_/g}' All_best.fasta.tmp > All_best.fasta

echo -ne "Done\n"        
kill $pid
echo ""

###     Begin clustering with VSEARCH (v2.13.0_linux_x86_64)

mkdir -v -p "${WKDIR}/output_data/trimmed/VSEARCH"
echo -e "\n#Begin clustering at $cluster_threshold %"

    #   dereplication 

        echo -e "\n#Performing dereplication"
        vsearch \
                --derep_fulllength "${WKDIR}/output_data/trimmed/All_best.fasta" \
                --output "${WKDIR}/output_data/trimmed/VSEARCH/best_derep.fasta" \
                --sizeout \
                --minuniquesize "${cluster_size}" \
                --relabel Unique \
                --uc "${WKDIR}/output_data/trimmed/VSEARCH/derep.uc" \
                --log="${WKDIR}/output_data/trimmed/VSEARCH/derep_log"
    
    #   removing chimeras

        echo -e "\n#Removing chimera"
        vsearch \
                --uchime_denovo "${WKDIR}/output_data/trimmed/VSEARCH/best_derep.fasta" \
                --sizein \
                --sizeout \
                --chimeras "${WKDIR}/output_data/trimmed/VSEARCH/chimera.fasta" \
                --nonchimeras "${WKDIR}/output_data/trimmed/VSEARCH/nonchimera.fasta" \
                --log="${WKDIR}/output_data/trimmed/VSEARCH/chimera_log.txt"
    
    # Clustering OTUs

        echo -e "\n#Clustering OTUs at ${cluster_threshold} % sequence similarity"
        vsearch \
                --cluster_size "${WKDIR}/output_data/trimmed/VSEARCH/nonchimera.fasta" \
                --id "${cluster_threshold}" \
                --centroid "${WKDIR}/output_data/trimmed/VSEARCH/pre_OTU.fasta" \
                --otutabout "${WKDIR}/output_data/trimmed/VSEARCH/classic_pre_otu_table.txt" \
                --uc "${WKDIR}/output_data/trimmed/VSEARCH/clustering_result" \
                --sizein \
                --sizeout \
                --relabel 'OTU_' \
                --biomout "${WKDIR}/output_data/trimmed/VSEARCH/pre_OTUtable.biom.json"
    
###     End of clustering with VSEARCH


###     Preparing input file for filtering of non target sequences

perl -pe '/^>/ ? print "\n" : chomp' ./VSEARCH/pre_OTU.fasta | \
    sed '/^$/d' > "${WKDIR}/output_data/trimmed/VSEARCH/pre_OTU.fasta.tmp"

###    Filtering non target sequences with BlastX from NCBI Blast+ (2.8.1)

echo -e "\n#Filtering non target OTUs"
echo -e "\n#OBS: This might take a while!"

processing
pid=$!
        
        blastx \
                -query "${WKDIR}/output_data/trimmed/VSEARCH/pre_OTU.fasta.tmp" \
                -db "/home/$user/acetoscan/acetobase/AcetoBaseV1" \
                -task blastx \
                -max_target_seqs 1 \
                -num_threads "${THREADS}" \
                -evalue 10e-5 \
                -out "${WKDIR}/output_data/trimmed/VSEARCH/blast_results_for_filtering" \
                -outfmt "7 qseqid"

        ###     Processing blast result file, deleting commented lines
        sed '/^#/d' ./VSEARCH/blast_results_for_filtering > "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU_list.txt"

        ###     Extracting target sequences

        while read line;
                do
                        grep -w -A 1 "$line" "${WKDIR}/output_data/trimmed/VSEARCH/pre_OTU.fasta.tmp" >> "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU.fasta.tmp"
                done < ${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU_list.txt

        # processing filtered OTU multifasta file

        sed -e 's/-/_/g;/^#/d' "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU.fasta.tmp" > "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU.fasta"

echo -ne "Done\n"
kill $pid

###    Generating OTU table with filtered/target OTUs

        echo -e "\n#Generating OTU table"
        vsearch \
                --usearch_global "${WKDIR}/output_data/trimmed/All_best.fasta" \
                --db "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU.fasta.tmp" \
                --id ${cluster_threshold} \
                --otutabout "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.tmp"

###     Processing Sample name

sed -e "s/Best_//g;s/_trimmed_${reads}//g" "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.tmp" > "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.pre"

###    Sorting OTUs in assending order

sed -e 's/#OTU ID/ID/' "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.pre" \
-e 's/OTU_//' | sort -n | sed -e 's/^/OTU_/' > "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.txt"

###     Preparing OTU table for R

cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.txt" "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table_R.txt"

###    Assigning taxonomy 

echo -e "\n#Assigning taxonomy"
echo -e "\n#OBS: This might take a while!"

processing
pid=$!

        cut -d ";" -f1 "${WKDIR}/output_data/trimmed/VSEARCH/filtered_OTU.fasta" > "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU.fasta"

        # assigning taxonomy by translated nucleotide query wait protein database
        blastx \
                -query "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU.fasta" \
                -db "/home/$user/acetoscan/acetobase/AcetoBaseV1" \
                -task blastx \
                -max_target_seqs 1 \
                -num_threads "${THREADS}" \
                -evalue 1e-9 \
                -out "${WKDIR}/output_data/trimmed/VSEARCH/OTUblast.txt.tmp" \
                -outfmt "6 qseqid saccver pident"

echo -ne "Done\n"
kill $pid

###    Preparing OTU taxonomy table

sed -e 's/;tax=/,/g' "${WKDIR}/output_data/trimmed/VSEARCH/OTUblast.txt.tmp" | \
sed '1s/^/#OTU,Subject_Accession,Kingdom,Phylum,Class,Order,Family,Genus,Species,Percentage_identity\n/' > "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_pre"

#    making tab to comma
sed -e 's/\t/,/g' "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_pre" > "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_full.csv"

###    fixing taxonomy to OTU fasta header 

cd "${WKDIR}/output_data/trimmed/VSEARCH/" 
if ! cd "${WKDIR}/output_data/trimmed/VSEARCH/" ; then
    echo -e "\n#Error: could not access ${WKDIR}/output_data/trimmed/VSEARCH/"
    exit 1
fi

###     Making Tax table
sed 's/;tax=/\t/g' OTUblast.txt.tmp | \
    awk -F "\t" '{print $1,$3,$4}' | \
    sed -e '1s/^/OTU_ID,Kingdom,Phylum,Class,Order,Family,Genus,Species,Percentage_identity \n/' \
        -e 's/ /,/g' > FTHFS_TAX_table.txt

###    Preparing the input for R analysis

sed 's/,/\t/g' "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table.txt" | \
    awk 'NF{NF--};1' | \
    sed 's/ /\t/g'> "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_R.txt"

###    Preparing input for R analysis

echo ""
mkdir -v -p "${WKDIR}/output_data/trimmed/VSEARCH/Visualization"
if ! cd "${WKDIR}/output_data/trimmed/VSEARCH/Visualization" ; then
    echo -e "\n#Error: could not access ${WKDIR}/output_data/trimmed/VSEARCH/Visualization"
    exit 1
fi

cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table_R.txt" .
cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_R.txt" .
cp "/home/$user/acetoscan/acetoscan_bin/AcetoScan_Visualization.R" .

###     Running R script

RPATH=$(which R)
echo -e "\n#Preparing graphics"

echo -e "\n#In case of execution halt, access data in path ${WKDIR}/output_data/trimmed/VSEARCH/\n"

###     Rscript not working

"${RPATH}" \
    --slave \
    --no-restore \
    --silent \
    --quiet \
    --file="AcetoScan_Visualization.R" > /dev/null

###    Putting everything together in a Result DIRECTORY = acetoscan_result or Visualization

mkdir -v -p "${WKDIR}/acetoscan_result"
cd "${WKDIR}/acetoscan_result" 


        #       result files

cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU.fasta" .
cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_OTU_table.txt" .
cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table_full.csv" .
cp "${WKDIR}/output_data/trimmed/VSEARCH/FTHFS_TAX_table.txt" .

###     Phylogenetic inference

mafft --reorder --thread "${THREADS}" FTHFS_OTU.fasta > FTHFS_OTU_alignment.fasta
fasttree -nt -gtr FTHFS_OTU_alignment.fasta > FTHFS_OTU.tree

        #       graphics

if [ -f "${WKDIR}/output_data/trimmed/VSEARCH/Visualization/Alpha_diversity.html" ]; then
        cp ${WKDIR}/output_data/trimmed/VSEARCH/Visualization/* .
        rm AcetoScan_Visualization.R
        rm FTHFS_*table_R.txt
        echo "-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.=================================================="
        echo "#Final results are in directory \"acetoscan_result\" in path ${WKDIR}/acetoscan_result"
        echo "-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.=================================================="
else
        rm AcetoScan_Visualization.R
        rm FTHFS_*table_R.txt
        echo "-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.=================================================="
        echo "#Final results are in directory \"Visualization\" in path ${WKDIR}/output_data/trimmed/VSEARCH/Visualization/"
        echo "#And OTU table and TAX table in \"acetoscan_result\" in path ${WKDIR}/acetoscan_result"
        echo "-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.=================================================="
fi

###    Getting final information

end=$(date +%s) # end time of script
runtime=$(((end - start))) # calculate runtime
echo -e "\n#Acetoscan runtime: ${runtime} seconds"

###    End of script

#!/bin/bash

# INSTALL for AcetoScan

# Last modified: tor maj 30, 2019  15:38
# Sign: Abhi

# setting pipefail

set -euo pipefail

##      Installation

##      Checking and installing Dependencies

###     Checking if cutadapt is installed

echo "Checking and installing dependencies for debian/ubuntu based systems"
if ! command -v "cutadapt" > /dev/null ; then
        echo "Installing Cutadapt"    
        sudo apt install -y cutadapt=1.18-1
fi

###     Checking if vsearch is installed

if ! command -v "vsearch" > /dev/null ; then
        echo "Installing Vsearch"
        wget "https://github.com/torognes/vsearch/releases/download/v2.13.1/vsearch-2.13.1-linux-x86_64.tar.gz"
        tar xzf vsearch-2.13.1-linux-x86_64.tar.gz
        sudo cp vsearch-2.13.1-linux-x86_64/bin/vsearch /usr/local/bin/vsearch
fi

###     Checking if Blast is installed

if ! command -v "blastx" > /dev/null ; then
        echo "Installing NCBI-blast+"
        sudo apt install -y ncbi-blast+
fi

###     Checking if bioperl is installed

        echo "Checking BioPerl"
        sudo apt install -y -qq < /dev/null > /dev/null

###     Checking if R and Rscript are installed

if ! command -v "R" > /dev/null ; then
        echo "Installing R"
        sudo apt install -y -qq \
                        libv8-dev \                                
                        r-base \
                        r-base-dev < /dev/null > /dev/null                               
fi

###     Installing R packages 

echo "Checking R dependencies"
        sudo apt install -y -qq \
                        r-bioc-phyloseq \
                        r-cran-dplyr \
                        r-cran-ggplot2 \
                        r-cran-plotly \
                        r-cran-plyr \
                        r-cran-rcolorbrewer < /dev/null > /dev/null

###     Copying Acetoscan executable to /usr/local/bin

sudo find / -type f -name "acetoscan" -exec cp {} /usr/local/bin/ \; 2>/dev/null
sudo chmod +x /usr/local/bin/acetoscan

###     fixing the directory for AcetoScan program

sudo mkdir -p /home/acetoscan/acetoscan_bin
sudo mkdir -p /home/acetoscan/acetobase

###     copying acetoscan dependencies to acetoscan_bin

sudo cp ./acetoscan_bin/* /home/acetoscan/acetoscan_bin/

###     Downloading AcetoBase

echo "Downloading AcetoBase"
sudo wget -P /home/acetoscan/acetobase/ "https://www.acetobase.molbio.slu.se/path/to/AcetoBase_V1.tgz"
sudo tar xvzf /home/acetoscan/acetobase/AcetoBase_V1.tgz  
